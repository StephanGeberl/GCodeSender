/*
    Copyright 2020 Stephan Geberl

    This file is part of Universal Gcode Sender (UGS) (5 Axis-Version).

    UGS is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    UGS is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with UGS.  If not, see <http://www.gnu.org/licenses/>.
 */
package com.geberl.gcodesender.uielements.components;

import javax.swing.*;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;

import java.util.List;

import com.geberl.gcodesender.connection.ConnectionFactory;
import com.geberl.gcodesender.listeners.ControllerListener;
import com.geberl.gcodesender.listeners.ControllerState;
import com.geberl.gcodesender.listeners.ControllerStatus;
import com.geberl.gcodesender.listeners.UGSEventListener;
import com.geberl.gcodesender.model.BaudRateEnum;
import com.geberl.gcodesender.model.Position;
import com.geberl.gcodesender.model.UGSEvent.ControlState;
import com.geberl.gcodesender.types.GcodeCommand;
import com.geberl.gcodesender.model.Alarm;
import com.geberl.gcodesender.model.BackendAPI;
import com.geberl.gcodesender.utils.Settings;
import com.geberl.gcodesender.utils.SettingsFactory;

import static com.geberl.gcodesender.utils.GUIHelpers.displayErrorDialog;

import java.awt.Color;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

public class ConnectionPanel extends JPanel implements ControllerListener, UGSEventListener {
	
	// Breite: 190
	// HÃ¶he: 160

	private final BackendAPI backend;
    private Settings settings;
    private int tempMode = -1;
    
    private JComboBox commPortComboBox = new JComboBox();
    private JComboBox baudrateSelectionComboBox = new JComboBox();
    private JButton opencloseButton = new JButton("Open");
    private JButton refreshButton = new JButton("");
    private JSlider modeSlider = new JSlider();
    private JLabel lblHotwireMode = new JLabel("HotWire");
    private JLabel lblMillMode = new JLabel("Mill");

	private JButton performHomingCycleButton = new JButton("Home ($H)");
	private JButton killAlarmLock = new JButton("Unlock ($X)");
	private JButton returnToZeroButton = new JButton("Return to Zero");
	private JButton resetCoordinatesButton = new JButton("Reset Zero");

    
    public ConnectionPanel(BackendAPI backend) {

    	this.backend = backend;
        this.settings = SettingsFactory.loadSettings();
        this.loadPortSelector();
//        commPortComboBox.setFont(new Font("Dialog", Font.BOLD, 14));
        commPortComboBox.setSelectedItem(settings.getPort());
        baudrateSelectionComboBox.setModel(new javax.swing.DefaultComboBoxModel(BaudRateEnum.getAllBaudRates()));
        baudrateSelectionComboBox.setSelectedItem(settings.getPortRate());

        initComponents();
 
        if (this.backend != null) {
        	
            this.backend.addUGSEventListener(this);
            this.backend.addControllerListener(this);
             
        }
        
        this.setMachineModeDeactivated();
    }
	
    private void initComponents() {
        
        setLayout(null);
        
        JLabel lblPort = new JLabel("Port");
        lblPort.setFont(new Font("DejaVu Sans", Font.BOLD, 16));
        lblPort.setBounds(6, 2, 44, 30);
        add(lblPort);
        
        JLabel lblNewLabel = new JLabel("Baud");
        lblNewLabel.setFont(new Font("DejaVu Sans", Font.BOLD, 16));
        lblNewLabel.setBounds(6, 34, 44, 30);
        add(lblNewLabel);
        
        
        // ======================

        lblHotwireMode.setFont(new Font("DejaVu Sans", Font.BOLD, 18));
        lblHotwireMode.setBounds(81, 98, 102, 30);
        lblHotwireMode.setForeground(Color.BLACK);
        add(lblHotwireMode);
        
        lblMillMode.setFont(new Font("DejaVu Sans", Font.BOLD, 18));
        lblMillMode.setBounds(81, 128, 102, 30);
        lblMillMode.setForeground(Color.BLACK);
        add(lblMillMode);
 
        // ======================

        commPortComboBox.setBounds(55, 2, 128, 30);
        commPortComboBox.setFont(new Font("DejaVu Sans", Font.BOLD, 14));
        commPortComboBox.setToolTipText("Select serial port.");        
        add(commPortComboBox);
        
        baudrateSelectionComboBox.setBounds(55, 34, 128, 30);
        baudrateSelectionComboBox.setFont(new Font("DejaVu Sans", Font.BOLD, 14));
        baudrateSelectionComboBox.setToolTipText("Select baudrate to use for the serial port.");        
        add(baudrateSelectionComboBox);
        
        // ======================
        
        opencloseButton.setBounds(87, 66, 96, 30);
        opencloseButton.setFont(new Font("DejaVu Sans", Font.BOLD, 16));
        opencloseButton.setText("Open");
        opencloseButton.addActionListener(new java.awt.event.ActionListener() {
            @Override
			public void actionPerformed(java.awt.event.ActionEvent evt) {
                opencloseButtonActionPerformed(evt);
            }
        });
        add(opencloseButton);
        
        refreshButton.setToolTipText("Reload Ports");
        refreshButton.setBounds(55, 66, 30, 30);
        refreshButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/icons/refresh.gif"))); // NOI18N
        refreshButton.addActionListener(new java.awt.event.ActionListener() {
            @Override
			public void actionPerformed(java.awt.event.ActionEvent evt) {
            	loadPortSelector();
            }
        });
        add(refreshButton);
        
        // ======================
               
        modeSlider.setValue(1);
        modeSlider.setOrientation(SwingConstants.VERTICAL);
        modeSlider.setMaximum(1);
        modeSlider.setBounds(45, 104, 35, 50);
        add(modeSlider);
        
        modeSlider.addChangeListener(new ChangeListener() {
        	public void stateChanged(ChangeEvent arg0) {
                switch (modeSlider.getValue()) {
            	case 0: // Mill
            		setMachineModeMill();
            		break;
            	case 1: // HotWire
               		setMachineModeHotWire();
            		break;
                default:
                    break;
                }
        	}
        });

        // ======================
        
        // performHomingCycleButton.setBackground(Color.ORANGE);
        performHomingCycleButton.setFont(new Font("DejaVu Sans", Font.BOLD, 16));
        performHomingCycleButton.setBounds(6, 162, 177, 40);
        add(performHomingCycleButton);
        
        performHomingCycleButton.addActionListener(new java.awt.event.ActionListener() {
            @Override
			public void actionPerformed(java.awt.event.ActionEvent evt) {
                performHomingCycleButtonActionPerformed(evt);
            }
        });
        performHomingCycleButton.setEnabled(false);
        
	    // killAlarmLock.setBackground(Color.ORANGE);
        killAlarmLock.setFont(new Font("DejaVu Sans", Font.BOLD, 16));
        killAlarmLock.setBounds(6, 204, 177, 40);
        add(killAlarmLock);
        
        killAlarmLock.addActionListener(new java.awt.event.ActionListener() {
            @Override
			public void actionPerformed(java.awt.event.ActionEvent evt) {
                killAlarmLockActionPerformed(evt);
            }
        });
        killAlarmLock.setEnabled(false);
        

        // resetCoordinatesButton.setBackground(Color.ORANGE);
        resetCoordinatesButton.setFont(new Font("DejaVu Sans", Font.BOLD, 16));
        resetCoordinatesButton.setBounds(6, 252, 177, 40);
        add(resetCoordinatesButton);

        // reset Functions
        resetCoordinatesButton.addActionListener(new ActionListener() {
        	public void actionPerformed(ActionEvent arg0) {
        		resetCoordinatesButtonActionPerformed(arg0);
        	}
        });
        resetCoordinatesButton.setEnabled(false);

        // returnToZeroButton.setBackground(Color.ORANGE);
        returnToZeroButton.setFont(new Font("DejaVu Sans", Font.BOLD, 16));
        
        returnToZeroButton.setBounds(6, 294, 177, 40);
        add(returnToZeroButton);

        returnToZeroButton.addActionListener(new java.awt.event.ActionListener() {
            @Override
			public void actionPerformed(java.awt.event.ActionEvent evt) {
                returnToZeroButtonActionPerformed(evt);
            }
        });
        returnToZeroButton.setEnabled(false);
        
        
        
        
        
        
    }

    
    // Scans for comm ports and puts them in the comm port combo box.
    private void loadPortSelector() {
        commPortComboBox.removeAllItems();

        List<String> portList = ConnectionFactory.getPortNames(backend.getSettings().getConnectionDriver());
        if (portList.size() < 1) {
            if (this.settings.isShowSerialPortWarning()) {
                displayErrorDialog("No serial ports found.");
            }
        } else {
            for (String port : portList) { commPortComboBox.addItem(port); }
            commPortComboBox.setSelectedIndex(0);
        }
    }
    
    private void opencloseButtonActionPerformed(java.awt.event.ActionEvent evt) {
        if( this.opencloseButton.getText().equalsIgnoreCase("Open") ) {

            String firmware = "GRBL";
        	String port = commPortComboBox.getSelectedItem().toString();
            int baudRate = Integer.parseInt(baudrateSelectionComboBox.getSelectedItem().toString());
            
            try {
                this.backend.connect(firmware, port, baudRate);
                this.setMachineModeActivated();

            } catch (Exception e) {
                e.printStackTrace();
                displayErrorDialog(e.getMessage());
            }
        } else {
            try {
                this.backend.disconnect();
                this.setMachineModeDeactivated();

            } catch (Exception e) {
            	displayErrorDialog(e.getMessage());
            }
        }
    }
    
    public void updateConnectionControlsStateOpen(boolean isOpen) {

        this.commPortComboBox.setEnabled(!isOpen);
        this.baudrateSelectionComboBox.setEnabled(!isOpen);
        this.refreshButton.setEnabled(!isOpen);

        if (isOpen) {
            this.opencloseButton.setText("Close");
        } else {
            this.opencloseButton.setText("Open");
        }
    }

    public void saveSettings() {
    	settings.setPort(commPortComboBox.getSelectedItem().toString());
    	settings.setPortRate(baudrateSelectionComboBox.getSelectedItem().toString());
    }

    private void setMachineModeHotWire() {
        try {
             tempMode = 1;
             this.backend.killAlarmLock();
             this.backend.switchToHotWire();
             lblHotwireMode.setForeground(Color.RED);
             lblMillMode.setForeground(Color.BLACK);
        } catch (Exception ex) {
        	displayErrorDialog("Error switching machine mode to HotWire.");
        }
     }

     private void setMachineModeMill() {
         try {
             tempMode = 0;
             this.backend.killAlarmLock();
             this.backend.switchToMill();
             lblHotwireMode.setForeground(Color.BLACK);
             lblMillMode.setForeground(Color.RED);
         } catch (Exception ex) {
        	 displayErrorDialog("Error switching machine mode to Mill.");
         }        
     }

     private void setMachineModeDeactivated() {
    	 this.modeSlider.setEnabled(false);
         lblHotwireMode.setForeground(Color.LIGHT_GRAY);
         lblMillMode.setForeground(Color.LIGHT_GRAY);
     }

     private void setMachineModeActivated() {
    	 this.modeSlider.setEnabled(true);
         switch (modeSlider.getValue()) {
         	case 0: // Mill
	           	 lblHotwireMode.setForeground(Color.BLACK);
	             lblMillMode.setForeground(Color.RED);
         		break;
         	case 1: // HotWire
	           	 lblHotwireMode.setForeground(Color.RED);
	             lblMillMode.setForeground(Color.BLACK);
         		break;
         	default:
         		break;
         }
    	 
     }

     private void setModeSlider(ControllerState state) {

     	if (state == ControllerState.ALARM) {
     		this.modeSlider.setEnabled(true);
         } else if (state == ControllerState.UNKNOWN) {
         	this.modeSlider.setEnabled(true);
         } else if (state == ControllerState.HOLD || state == ControllerState.DOOR || state == ControllerState.SLEEP) {
         	this.modeSlider.setEnabled(true);
         } else if (state == ControllerState.RUN || state == ControllerState.JOG || state == ControllerState.HOME) {
         	this.modeSlider.setEnabled(false);
         } else {
         	this.modeSlider.setEnabled(true);
         }

     }

     // Funktionen Buttons
     
     private void performHomingCycleButtonActionPerformed(java.awt.event.ActionEvent evt) {
         try {
             this.backend.performHomingCycle();
         } catch (Exception ex) {
             displayErrorDialog(ex.getMessage());
         }
     }
     

     private void killAlarmLockActionPerformed(java.awt.event.ActionEvent evt) {
         try {
             this.backend.killAlarmLock();
         } catch (Exception ex) {
             displayErrorDialog(ex.getMessage());
         }
     }

     private void resetCoordinatesButtonActionPerformed(java.awt.event.ActionEvent evt) {
         try {
         	if (backend.isMillMode()) {
         		this.backend.resetCoordinatesToZeroMill();
         	}
         	else {
         		this.backend.resetCoordinatesToZero();
         	}
         } catch (Exception ex) {
             displayErrorDialog(ex.getMessage());
         }
     }
 	
     private void returnToZeroButtonActionPerformed(java.awt.event.ActionEvent evt) {
         try {
             this.backend.returnToZero();
         } catch (Exception ex) {
             displayErrorDialog(ex.getMessage());
         }
     }

     // Update Buttons
     
     
	private void updateControls() {

		switch (backend.getControlState()) {
			case COMM_DISCONNECTED:
			case COMM_SENDING_PAUSED:
			case COMM_CHECK:
			default:
				updateManualControls(false);
				break;
			case COMM_IDLE:
			case COMM_SENDING:
				updateManualControls(!backend.isSendingFile());
				break;
		}
	}
    
	public void updateManualControls(boolean enabled) {
		
		// Always enabled
//		this.helpButtonMachineControl.setEnabled(true);
//		this.btnSenderSettings.setEnabled(true);
//		this.btnGcodeSettings.setEnabled(true);
		
		// Enabled when connected
		this.killAlarmLock.setEnabled(enabled);
//		this.softResetMachineControl.setEnabled(enabled);
		this.returnToZeroButton.setEnabled(enabled);
		this.resetCoordinatesButton.setEnabled(enabled);
//		this.storePosition.setEnabled(enabled);
//		this.storeSaveHeight.setEnabled(enabled);
//		this.gotoStoredPosition.setEnabled(enabled);
		this.performHomingCycleButton.setEnabled(enabled);
//		this.btnFirmwareSettings.setEnabled(enabled);
//		this.yaMinusButton.setEnabled(enabled);
//		this.yaPlusButton.setEnabled(enabled);
//		this.xzMinusButton.setEnabled(enabled);
//		this.xzPlusButton.setEnabled(enabled);
//		this.feedRateSpinner.setEnabled(enabled);
//		this.stepSizeSpinner.setEnabled(enabled);
//		this.feedRateLabel.setEnabled(enabled);
//		this.stepSizeLabel.setEnabled(enabled);
//		this.rdbtnMm.setEnabled(enabled);
//		this.rdbtnInch.setEnabled(enabled);
		
	
	}
     
     
     // Overrides
	 
	@Override
	public void UGSEvent(com.geberl.gcodesender.model.UGSEvent evt) {
		
	    if (evt.isFileChangeEvent() || evt.isStateChangeEvent()) {
	         
	    	// opencloseButton.setEnabled(backend.isIdle());

	    	switch (backend.getControlState())
	    	{
	             case COMM_DISCONNECTED:
	                 this.setModeSlider(ControllerState.UNKNOWN);
	                 this.updateConnectionControlsStateOpen(false);
	                 break;
	             case COMM_IDLE:
	            	 this.updateConnectionControlsStateOpen(true);
	                 break;
	             case COMM_SENDING:
	            	 updateManualControls(!backend.isSendingFile());
	                 break;
	             case COMM_SENDING_PAUSED:

	                 break;
	             default:
	            	 
	            	 break;
	                 
	         }
	    	updateControls();
	    
	    }
	
	    if (evt.isSettingChangeEvent() && backend.getController() != null && backend.getController().getControllerStatus() != null)
	    {
	        statusStringListener(backend.getController().getControllerStatus());
	    }
		
	}
	
	@Override
	public void statusStringListener(ControllerStatus status) {
		
		updateControls();
		
		if (status == null) {
	        return;
	    }
	
	    this.setModeSlider( status.getState() );
	    
	    switch (status.getMachineMode()) {
	    	case "HotWire":
	    		if (tempMode < 0) { this.modeSlider.setValue(1); }
	    		else { if (this.modeSlider.getValue() == 1) { tempMode = -1; }; };
	    		break;
	    	case "Mill":
	    		if (tempMode < 0) { this.modeSlider.setValue(0); }
	    		else { if (this.modeSlider.getValue() == 0) { tempMode = -1; }; };
	    		break;
	        default:
	            break;      
	    }
	
		
	}
	
	@Override
	public void controlStateChange(ControlState state) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void fileStreamComplete(String filename, boolean success) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void receivedAlarm(Alarm alarm) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void commandSkipped(GcodeCommand command) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void commandSent(GcodeCommand command) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void commandComplete(GcodeCommand command) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void commandComment(String comment) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void probeCoordinates(Position p) {
		// TODO Auto-generated method stub
		
	}

}
